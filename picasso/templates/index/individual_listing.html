{% extends 'main_template.html' %}
{% load staticfiles %}
{% load mathfilters %}
%{% block content %}
    <div id="main-section">
        <div class="container mt50" id="listing-detail">
            <div class="row">
                <!-- Slider -->
                <div class="col-sm-12">
                    <h2 class="lined-heading"><span>{{ listing.listing_name }}</span></h2>
                </div>
                <section class="standard-slider room-slider">
                    <div class="col-sm-12 col-md-6 col-lg-6">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="item"><img
                                        src="{{ listing.get_photo_url }}" alt="{{ listing.get_string_tags }}"
                                        class="img-responsive">
                                </div>
                            </div>
                        </div>
                        <div class="row mt20">
                            <div class="col-sm-12">
                                <div id="map-canvas" style="width: 100%; min-height: 300px"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-6 col-lg-6">
                        <div class="tab-pane fade in active" id="overview">
                            <div class="tp-leftarrow tparrows default detail-back"></div>
                            <h3>
                                Overview
                            </h3>

                            <p><strong>Subjects: </strong>{{ listing.get_string_tags }}</p>

                            <p>{{ listing.description|safe }}</p>

                            <p><strong>Address: </strong>{{ listing.address|safe }}</p>

                            {% if listing.active %}<p>
                                <strong>Currently Accepting Students: </strong><i class="fa fa-2x fa-check-circle"></i>
                                </p>{% endif %}

                            {% if listing.phone != "" %}<p><strong>Phone:</strong>{{ listing.phone }}</p>{% endif %}
                            <p><strong>Rating:</strong><input id="static-rating" class="rating" readonly></p>

                            {% if listing.owner == user or listing.created_by == user %}
                                <button type="button" class="btn btn-primary btn-block" id="edit-listing-button"
                                        data-url="{% url 'profile:edit_listing' listing.id %}">Edit
                                </button>
                            {% endif %}

                            {% if user.is_authenticated %}
                                {% if listing not in user.profile.teachers.all %}
                                    <button type="button" class="btn btn-primary btn-block mt20" id="add-teacher">Add to
                                        Favourites
                                    </button>
                                {% else %}
                                    <button type="button" class="btn btn-primary btn-block mt20" disabled>Favourite
                                    </button>
                                {% endif %}

                                <button type="button" class="mt20 btn btn-primary btn-block" id="review-button">Review
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </section>
            </div>
            {% if not reviewed and listing.owner != user %}
                <div class="row mt20">
                    <div class="col-sm-12">
                    </div>
                </div>
                <div class="row" id="review_form" style="display: none">
                    <form class="clearfix mt50" role="form" method="post"
                          action="{% url 'review_listing' listing.id %}"
                          id="reviewform" onsubmit="javascript:void(0)">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="review-comment" accesskey="S"><span class="required">*</span>Comment</label>
                            <textarea name="comment" id="review-comment" class="form-control"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="review-rating" accesskey="S"><span class="required">*</span>Rating</label>
                            <input id="review-rating" name="rating" class="form-control">
                        </div>
                        <div class="error_message">

                        </div>
                        <button type="button" class="btn  btn-lg btn-primary" id="cancel-review-button">Cancel</button>
                        <button type="button" class="btn  btn-lg btn-primary" id="review-submit"
                                data-url="{% url 'review_listing' listing.id %}">
                            Submit Review
                        </button>
                    </form>
                </div>
            {% endif %}
            <div class="row" {% if listing.review_set.count == 0 %}style="display:none;"{% endif %} id="reviews-box">
                <!-- Testimonials -->
                <section class="testimonials mt50">
                    <div class="col-md-12 col-sm-12">
                        <h3 class="lined-heading"><span>Testimonials</span></h3>

                        <div id="owl-reviews" class="owl-carousel mt30 owl-theme" style="display: block; opacity: 1;">
                            <div class="owl-wrapper-outer">
                                <div class="owl-wrapper"
                                     style="width: 2440px; left: 0px; display: block; transition: all 1000ms ease; -webkit-transition: all 1000ms ease; -webkit-transform: translate3d(0px, 0px, 0px);">
                                    {% for review in listing.review_set.all %}
                                        {% if forloop.counter0|mod:2 == 0 %}
                                            <div class="owl-item" style="width: 610px;">
                                        {% endif %}
                                    {% include 'index/review.html' with review=review count=forloop.counter %}
                                    {% if forloop.counter0|mod:2 == 1 %}
                                        </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% if listing.review_set.count >= 3 %}
                                <div class="owl-controls clickable">
                                    <div class="owl-buttons">
                                        <div class="owl-prev"><i class="fa fa-angle-left fa-3x"></i></div>
                                        <div class="owl-next"><i class="fa fa-angle-right fa-3x"></i></div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    <script>
        $(function () {
            var $main = $('#main-section');
            var $my_listings = $('#listing-detail');

            $main.on('click', '#edit-listing-button', function () {
                var url = $(this).data('url');
                $.get(url, function (data) {
                    $('#listing-detail').hide();
                    $main.append(data);
                    $("#are-owner").bootstrapSwitch();
                    $("#are-active").bootstrapSwitch();
                });
            });

            $main.on('click', '#cancel-edit-listing', function () {
                $('#edit-listing-div').remove();
                $('#listing-detail').show();
            });

            $main.on('click', '.detail-back', function () {
                window.location.href = '/';
            });

            $main.on('click', '#save-edit-listing', function () {
                var url = $(this).data('url');
                $.post(url, {'listing_name': $('#listing-name').val(), 'description': $('#listing-description').val(),
                            'address': $('#listing-address').val(), 'postal': $('#listing-postal').val(),
                            'city': $('#listing-city').val(), 'country': $('#listing-country').val(),
                            'phone': $('#listing-phone').val(), 'owner': $('#are-owner').is(':checked'),
                            'active': $('#are-active').is(':checked'),
                            'csrfmiddlewaretoken': $($('input[name="csrfmiddlewaretoken"]')[0]).val()},
                        function (data) {
                            $('#edit-listing-div').remove();
                            $my_listings.find('#listing-' + data['id']).remove();
                            $('#listing-detail').remove();
                            $.get('/main/detail-listing/' + data['id'], function (data2) {
                                $main.prepend(data2);
                            });
                            $my_listings.show();
                        });
            });

            $('#add-teacher').click(function () {
                $.post('{% url 'profile:add_teacher' listing.id %}', function () {
                    var $add = $('#add-teacher');
                    $add.text('Favourite');
                    $add.prop('disabled', true);
                });
            });

            function loadScript() {
                var script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = 'https://maps.googleapis.com/maps/api/js?v=3.exp&' +
                        'callback=initialize';
                document.body.appendChild(script);
            }

            $main.on('click', '#review-button', function () {
                {% if user.is_authenticated %}
                    $('#review_form').show();
                    $("#review-rating").rating({'min': 0, 'max': 5, 'step': 0.5});
                {% else %}
                    $('#main-section').hide();
                    $('#sign-in-lightbox').show();
                    $('#sign-up-stuff').show();
                    $('#signin-heading').text('Sign Up');
                    $('#type-signin').val('sign-up');
                    $('#sign-in-button').text('Sign Up');
                {% endif %}
            });
            $main.on('click', '#cancel-review-button', function () {
                $('#review_form').hide();
            });
            $main.on('click', '#review-submit', function () {
                var url = $(this).data('url');
                $.post(url, {'comment': $('#review-comment').val(), 'rating': $('#review-rating').val(),
                    'csrfmiddlewaretoken': $($('input[name="csrfmiddlewaretoken"]')[0]).val()}, function (data) {
                    var $owls = $('.owl-item');
                    var $items = $owls.find('.item');
                    if ($owls.length == 0) {
                        $('.owl-wrapper').append('<div class="owl-item" style="width: 610px;">' + data + '</div>');
                    } else {
                        if ($items.length % 2 == 1) {
                            $($owls[$owls.length - 1]).append(data);
                        } else {
                            $('.owl-wrapper').append('<div class="owl-item" style="width: 610px;">' + data + '</div>');
                        }
                    }
                    $('#review_form').remove();
                    $('#review-button').remove();
                    $('#reviews-box').show();
                });
            });

            loadScript();
        });
        var geocoder = null;
        var directionsDisplay = null;
        var initialLocation = null;
        var directionsService = null;
        function initialize() {
            directionsDisplay = new google.maps.DirectionsRenderer();
            directionsService = new google.maps.DirectionsService();

            var mapOptions = {
                zoom: 15,
                center: new google.maps.LatLng(-34.397, 150.644)
            };

            var map = new google.maps.Map(document.getElementById('map-canvas'),
                    mapOptions);
            directionsDisplay.setMap(map);

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                    if (initialLocation != null) {
                        var request = {
                            origin: initialLocation,
                            destination: pos,
                            travelMode: google.maps.TravelMode.DRIVING
                        };
                        directionsService.route(request, function (result, status) {
                            if (status == google.maps.DirectionsStatus.OK) {
                                directionsDisplay.setDirections(result);
                            }
                        });
                    }
                });
            }
            {% if listing.address != None %}
                var pos = new google.maps.LatLng({{ listing.address.point.y }}, {{ listing.address.point.x }});
                var marker = new google.maps.Marker({
                    map: map,
                    position: pos,
                    title: '{{ listing.listing_name }}',
                    visible: true
                });
                map.setCenter(pos);
            {% endif %}
        }
    </script>
{% endblock %}